{
  "feature": "component-id-card-ingestion-and-tree-projection",
  "purpose": "This document represents modeling and steps for the purpose of implementing ingestion of Component ID Cards, creation of ECS entities for each card, persistence to/from disk, and projection of all known component entries into the Tree pane in the Tree pane. This feature does not create spatial placements. Spatial placement is not required for existence.",
  "scope": [
    "Load previously persisted Component ID Cards into loaded_component_id_cards at program start.",
    "Import Component ID Cards from a JSON file or folder while running.",
    "Validate against component-id-card-schema.",
    "Persist valid cards to disk cache.",
    "Create ECS entity for each imported/loaded card.",
    "Populate Tree widget with entries representing known components from ECS state.",
    "No spatial placement",
    "No routing or wire rendering"
  ],
  "ontology": {
    "identity-layer": "cmp_entities + cmp_card_ref",
    "persistence-layer": "loaded_component_id_cards",
    "spatial-layer": "cmp_spatial (optional; absent means not placed)",
    "projection-root-for-tree": "cmp_entities + cmp_card_ref",
    "projection-root-for-canvas": "cmp_entities intersect keys(cmp_spatial)",
    "topology-independence": "Components may participate in router topology even if they have no spatial placement."
  },
  "ingestion-flow": {
    "steps": [
      "User selects Import Card or Import Card Folder",
      "Open file or directory dialog",
      "Parse JSON",
      "Validate against component-id-card-schema",
      "Persist to disk (component-id-cards/)",
      "Insert or replace entry in loaded_component_id_cards keyed by canonical inbox",
      "Allocate new ECS ID",
      "Add ECS ID to cmp_entities",
      "Set cmp_card_ref[eid] = component_id_card",
      "Do NOT create cmp_spatial entry",
      "Trigger Tree rebuild"
    ]
  },
  "defined-state": {
    "loaded_component_id_cards": {
      "defined-in": {
        "module": "component_registry.py",
        "name": "loaded_component_id_cards"
      },
      "type": "dict[str -> component_id_card]",
      "key": "str -- canonical absolute inbox path",
      "role": "persistence-cache",
      "description": "Disk-backed cache of imported Component ID Cards. Used for startup reload and as a stable cache independent of ECS identity."
    },
    "cmp_entities": {
      "defined-in": {
        "module": "ecs_world.py",
        "name": "cmp_entities"
      },
      "type": "set[int]",
      "role": "identity-layer",
      "description": "Set of ECS IDs representing all known component instances, placed or not."
    },
    "cmp_card_ref": {
      "defined-in": {
        "module": "ecs_world.py",
        "name": "cmp_card_ref"
      },
      "type": "dict[int -> component_id_card]",
      "role": "metadata-layer",
      "description": "Maps ECS IDs to Component ID Card objects. The card object must be a member of loaded_component_id_cards."
    },
    "g_tree_rebuild_suppress_events": {
      "defined-in": {
        "module": "tree_projection.py",
        "name": "g_tree_rebuild_suppress_events"
      },
      "type": "bool",
      "role": "projection-internal",
      "description": "Module-internal suppression flag to prevent Tree selection-change handlers from firing during a full rebuild."
    }
  },
  "ui-entry-point": {
    "menu-bar": {
      "required": true,
      "defined-in": {
        "module": "gui_scaffold.py",
        "name": "<tbd-menubar-var>"
      },
      "menus": [
        {
          "label": "File",
          "items": [
            {
              "label": "Import Card...",
              "underline": 0,
              "command": "cmd_import_component_id_card_file"
            },
            {
              "label": "Import Card Folder...",
              "underline": 12,
              "command": "cmd_import_component_id_card_folder"
            },
            "separator",
            {
              "label": "Exit",
              "underline": 1,
              "command": "cmd_exit"
            }
          ]
        }
      ]
    }
  },
  "validation-rules": [
    "schema_version must equal 1",
    "inbox and outbox must be canonical absolute paths",
    "channels.in and channels.out must be arrays of strings",
    "Channel names must be unique within their respective arrays"
  ],
  "persistence": {
    "disk-location": "lionscliapp data directory / component-id-cards/",
    "format": "One JSON file per Component ID Card",
    "filename-rule": "Derived from canonical inbox path (sanitized or hashed)",
    "startup-load": "Enumerate *.json, parse+validate, populate loaded_component_id_cards",
    "startup-validation": "If inbox/outbox folders do not exist: delete cached file, remove from loaded_component_id_cards, and remove any ECS entities referencing the card; log full card to log."
  },
  "ecs-creation-rules": {
    "when": [
      "After a card is successfully loaded at startup",
      "After a card is successfully imported during runtime"
    ],
    "steps": [
      "Allocate new ECS ID",
      "Add ECS ID to cmp_entities",
      "Set cmp_card_ref[eid] = component_id_card",
      "Do NOT create cmp_spatial entry"
    ],
    "notes": "ECS IDs are the canonical identity of known components inside Atlas. A component may exist without spatial placement."
  },
  "tree-node-format": {
    "node-id": "Tree widget internal identifier",
    "key": "eid (ECS ID)",
    "text": "cmp_card_ref[eid].title",
    "values": {
      "eid": "int",
      "inbox": "component_id_card.inbox",
      "outbox": "component_id_card.outbox"
    },
    "tags": [
      "component"
    ]
  },
  "tree-projection": {
    "source": "cmp_entities",
    "rules": [
      "Tree is a pure projection of cmp_entities + cmp_card_ref.",
      "Tree contains all ECS entities regardless of spatial placement.",
      "Tree ordering is not semantically meaningful in v0.1.",
      "Preserve selection across rebuild whenever possible (within the current runtime session)."
    ]
  },
  "tree-rebuild-algorithm": {
    "trigger": [
      "After startup load completes",
      "After runtime import completes",
      "After card invalidation causes ECS entity removal"
    ],
    "steps": [
      "Set g_tree_rebuild_suppress_events = true",
      "Capture currently selected Tree key (eid), if any",
      "Clear entire Tree",
      "For each eid in cmp_entities (stable sort optional): insert a Tree node using cmp_card_ref[eid]",
      "If previously selected eid still exists, restore selection",
      "Set g_tree_rebuild_suppress_events = false"
    ],
    "notes": "Full rebuild is preferred in v0.1. Incremental diff reconciliation is out of scope."
  },
  "commands": {
    "cmd_import_component_id_card_file": {
      "description": "Opens a file dialog allowing selection of a single JSON Component ID Card.",
      "flow": [
        "Open file dialog (filter: *.json)",
        "Read selected file",
        "Parse JSON",
        "Validate against component-id-card-schema",
        "Persist card to disk cache",
        "Insert or replace entry in loaded_component_id_cards keyed by canonical inbox",
        "Create ECS entity and cmp_card_ref binding",
        "Trigger Tree rebuild"
      ]
    },
    "cmd_import_component_id_card_folder": {
      "description": "Opens a directory dialog allowing selection of a folder containing multiple Component ID Card JSON files.",
      "flow": [
        "Open directory dialog",
        "Enumerate *.json files",
        "For each file: read, parse, validate",
        "For each valid card: persist to disk cache; insert/replace loaded_component_id_cards entry; create ECS entity",
        "After batch complete: trigger Tree rebuild once"
      ]
    }
  },
  "ui-contract": {
    "tree-pane-id": "main-pane-row.left-pane.component-tree",
    "selection-behavior": [
      "Selecting a Tree node highlights it",
      "Selection does not create spatial placement",
      "Selection does not modify router state"
    ],
    "events-emitted": [
      "component-selected (ecs-id)"
    ],
    "event-suppression": "Selection-change handlers must no-op while g_tree_rebuild_suppress_events is true."
  },
  "invariants": [
    "Every ECS entity must have a corresponding entry in cmp_card_ref.",
    "Every Tree node corresponds to exactly one ECS entity.",
    "Every cmp_card_ref value must be a member of loaded_component_id_cards.",
    "A component may exist and participate in topology without spatial placement.",
    "Tree state is fully reconstructable from ECS and current selection state (runtime only)."
  ],
  "non-goals": [
    "Automatic filesystem watching",
    "Spatial placement (auto-placement on canvas)",
    "Topology projection (wire rendering)",
    "Router mutation / router interaction",
    "Component dragging",
    "Persistence of UI selection across restarts"
  ]
}
